---
title: 智慧100V6.1完整部署指南
date: 2022-12-02T05:04:40
---

# 智慧100V6.1完整部署指南

* [智慧100V6.1完整部署指南](#智慧100v61完整部署指南)

  * [前置声明](#前置声明)
  * [一、系统环境准备](#一系统环境准备)
  * [1\. 申请APP企业名称](#1-申请app企业名称)
  * [2\. 整理服务部署清单](#2-整理服务部署清单)
  * [3\. 磁盘分区和挂载](#3-磁盘分区和挂载)
  * [4\. 创建交换分区](#4-创建交换分区)
  * [5\. 安装内部下载工具](#5-安装内部下载工具)
  * [二、安装基础服务](#二安装基础服务)
  * [1\. 安装JDK](#1-安装jdk)
  * [2\. 安装postgresql](#2-安装postgresql)

    * [注意事项](#注意事项)
  * [3\. 安装redis](#3-安装redis)
  * [4\. 安装RabbitMQ](#4-安装rabbitmq)
  * [5\. 安装openresty](#5-安装openresty)
  * [6\. 安装nacos](#6-安装nacos)
  * [7\. 安装filebeat](#7-安装filebeat)
  * [8\. 安装apache-tomcat](#8-安装apache-tomcat)
  * [三、业务库初始化](#三业务库初始化)
  * [1\. apaas 数据库初始化](#1-apaas-数据库初始化)
  * [2\. 数据平台数据库初始化](#2-数据平台数据库初始化)
  * [3\. ipaas 数据库初始化](#3-ipaas-数据库初始化)
  * [四、业务服务安装](#四业务服务安装)
  * [前置准备工作](#前置准备工作)

    * [导入 nacos 配置](#导入-nacos-配置)
    * [部署目录准备](#部署目录准备)
    * [放置种子文件到特定目录](#放置种子文件到特定目录)
    * [运维工具安装](#运维工具安装)
    * [获取版本服务清单](#获取版本服务清单)
  * [根据服务清单一键安装所有服务](#根据服务清单一键安装所有服务)
  * [单个业务服务安装](#单个业务服务安装)

    * [accountserv](#accountserv)
    * [etlserv](#etlserv)
    * [ideserv](#ideserv)
    * [masterserv](#masterserv)
    * [messageserv](#messageserv)
    * [platformserv](#platformserv)
    * [注意事项](#注意事项-1)
    * [queueserv](#queueserv)
    * [taskserv](#taskserv)
    * [authserver](#authserver)
    * [resourceconfig-service](#resourceconfig-service)
    * [dynamic-bizengine](#dynamic-bizengine)
    * [impexp](#impexp)
    * [offline-engine](#offline-engine)
    * [biengine](#biengine)
    * [apaasadmin](#apaasadmin)
    * [flowengine-rest](#flowengine-rest)
    * [processdesigner](#processdesigner)
    * [announcement-rest](#announcement-rest)
    * [opendata](#opendata)
    * [litheform-service](#litheform-service)
    * [lightform-web](#lightform-web)
    * [lightform-configuration](#lightform-configuration)
    * [apaas/web](#apaasweb)
    * [注意事项](#注意事项-2)
    * [appmanager](#appmanager)
    * [productoperation](#productoperation)
    * [k100master](#k100master)
    * [dym-plugin](#dym-plugin)
    * [direport](#direport)
    * [wechatservice](#wechatservice)
    * [h5-app](#h5-app)
    * [h5-ide](#h5-ide)
    * [license-service](#license-service)
    * [xwdatax](#xwdatax)
    * [datamanager-admin](#datamanager-admin)
    * [datamanager-web](#datamanager-web)
    * [dataintegration-executor](#dataintegration-executor)
    * [bimobileweb](#bimobileweb)
    * [admin](#admin)
    * [flystep](#flystep)
    * [router](#router)
    * [ipaas/web](#ipaasweb)
    * [注意事项](#注意事项-3)
  * [五、开户验证](#五开户验证)
  * [1\. 导入V6.1元数据](#1-导入v61元数据)
  * [2\. 开户验证](#2-开户验证)
  * [部署常见问题 FAQ](#部署常见问题-faq)
  * [工具问题](#工具问题)

    * [Q: svn 连接超时，无法通过 svn 下载归档资源](#q-svn-连接超时无法通过-svn-下载归档资源)
    * [Q: svn 提示输入 root 密码](#q-svn-提示输入-root-密码)
    * [Q: sdhelper 工具下载的安装包放在哪个位置](#q-sdhelper-工具下载的安装包放在哪个位置)
    * [Q: sdhelper 工具是怎么做备份的，服务目录下原来的文件和日志能否找回](#q-sdhelper-工具是怎么做备份的服务目录下原来的文件和日志能否找回)
  * [异常排查思路](#异常排查思路)

    * [Q: 根据服务的ip和端口，如何判断对应了哪个服务](#q-根据服务的ip和端口如何判断对应了哪个服务)
    * [Q: 如何查看nginx日志](#q-如何查看nginx日志)
    * [Q: nginx路由的服务ip地址不对，需要在哪里修正](#q-nginx路由的服务ip地址不对需要在哪里修正)
    * [Q: 接口请求出错了，如何确定接口请求了哪个服务](#q-接口请求出错了如何确定接口请求了哪个服务)
    * [Q: 如何查看服务日志](#q-如何查看服务日志)
    * [Q: 服务启动失败如何排查](#q-服务启动失败如何排查)
    * [Q: 根目录(/)的磁盘满了，是什么问题](#q-根目录的磁盘满了是什么问题)
  * [服务安装异常](#服务安装异常)

    * [Q: 业务服务没有正确连接上 nacos，导致启动失败或者其他异常](#q-业务服务没有正确连接上-nacos导致启动失败或者其他异常)
    * [Q: 业务服务报错连接数据库、redis超时，或请求其他服务超时](#q-业务服务报错连接数据库redis超时或请求其他服务超时)
    * [Q: 请求 backend 18080 端口超时](#q-请求-backend-18080-端口超时)
    * [Q: 如何判断 backend 相关服务是否启动成功，或者是否挂了](#q-如何判断-backend-相关服务是否启动成功或者是否挂了)
    * [Q: 请求 backend 相关服务404](#q-请求-backend-相关服务404)
  * [开户失败](#开户失败)

    * [Q: 初始化数据库失败，报错缺少 pg\_restore 命令](#q-初始化数据库失败报错缺少-pg_restore-命令)
    * [Q: 初始化数据库失败，报错缺少对应种子库文件](#q-初始化数据库失败报错缺少对应种子库文件)
    * [Q: 初始化数据平台失败，报错缺少对应种子库库文件](#q-初始化数据平台失败报错缺少对应种子库库文件)
    * [Q: 初始租户数据库失败，报错 "cannot execute CREATE SCHEMA in a read-only transaction"](#q-初始租户数据库失败报错-cannot-execute-create-schema-in-a-read-only-transaction)
    * [Q: platformserv 服务没连上 nacos](#q-platformserv-服务没连上-nacos)
  * [业务错误](#业务错误)

    * [Q: 服务多实例部署时，插入数据时生成的 id 出现冲突](#q-服务多实例部署时插入数据时生成的-id-出现冲突)
    * [Q: 业务接口报错缺少 `st_makepoint` 函数](#q-业务接口报错缺少-st_makepoint-函数)
    * [Q: 已安装并启用了 postgis 插件，但是业务接口报错缺少 `st_distance_sphere` 函数](#q-已安装并启用了-postgis-插件但是业务接口报错缺少-st_distance_sphere-函数)
    * [Q: 开户后涉及企微的相关接口会报错不可用](#q-开户后涉及企微的相关接口会报错不可用)

## 前置声明

1. 本指南对应 Linux 发行版为 CentOS 7.5
2. 本指南涉及的 Bash 命令，仅供参考。不建议直接复制执行，也无法保证兼容所有情况，请部署同学根据实际情况调整
3. nacos 配置务必根据实际服务部署情况进行调整
4. 本指南指在引导部署同学从0到1部署整套智慧100服务，包括基础依赖服务。若只需要某部分服务，也可以选择性查阅
5. ***目前存在有些华为云ip网段无法直接访问svn的情况，如果 `svn export` 或 `svn_exporter` 命令请求超时，请先在可以访问svn的机器上执行相关下载命令，再手动 `scp` 下载的内容到对应服务器上***

## 一、系统环境准备

### 1\. 申请APP企业名称

我们的APP是支持多环境的，新环境的APP企业名称需要跟PMO `李瑞烜` 申请（或者找运维同事申请，根据实际情况来）。需要使用到 APP 功能可以进行申请，申请工作和环境部署互不影响，可以同时进行。

申请时需要提供以下信息：

* APP企业名称：`{按需申请}`
* 业务接口地址：`{openresty部署服务器ip}:7000`
* IDE接口地址：`{openresty部署服务器ip}:8001`

### 2\. 整理服务部署清单

如果是多机部署的环境，在具体部署前，需要整理一份服务部署清单，单机部署的环境可以忽略此步骤。

此文档需要结合运维提供的服务器信息进行整理，具体清单内应该至少能提供以下信息：

* 每台服务器的内网地址（配置nacos和nginx需要用到）
* 每台服务器计划安装哪些服务（决定了每台机器需要安装哪些基础服务和业务服务）

此文档将作为后续服务部署和问题排查的指导文档，进一步可作为客户交付材料之一。

### 3\. 磁盘分区和挂载

> 服务器有加购数据盘，才需要进行挂载，否则可以忽略此步骤。多机部署环境，注意每台机器都要先检查下磁盘信息。

1. 查看磁盘信息

```bash
fdisk -l
```

下图示例中可以看到，/dev/vdb 磁盘未挂载使用

![fdisk示例1](http://apaas.wxchina.com:8881/wp-content/uploads/fdisk%E7%A4%BA%E4%BE%8B1.png)

1. 磁盘分区

如果整个磁盘一起使用，也可以不分区。需要分区可以使用 `fdisk` 命令进行操作。

```bash
# <code>fdisk</code> 分区操作涉及命令行交互，记住两个命令：n（新建分区）、w（保存并应用分区），其他操作看交互提示即可
fdisk /dev/vdb
```

![fdisk示例2](http://apaas.wxchina.com:8881/wp-content/uploads/fdisk%E7%A4%BA%E4%BE%8B2.png)

1. 格式化分区

```bash
# 如果执行了上面的分区命令，查看分区，将看到vdb磁盘下多了一个vdb1分区，并且没有实例化（UUID为空）
lsblk -f

# 对刚刚新建分区进行格式化，磁盘类型为ext4
mkfs.ext4 /dev/vdb1
```

1. 创建目录并设置永久挂载

```bash
# 查看设备 UUID
blkid -s UUID /dev/vdb1

# 修改 /etc/fstab
# ***以下UUID根据实际情况修改***
# ***磁盘挂载目录根据实际需要调整，单独部署数据库的服务器，可以优先将更大的磁盘挂载到数据存储目录。一般业务场景使用的服务器，将磁盘挂载到 /home 目录即可***
cat >> /etc/fstab << EOF

UUID=9d87a2ea-5543-46c2-8068-492f4d73aaaa /home                   ext4    defaults        0 0
EOF

# 依据 /etc/fstab 的内容，自动挂载设备
mount -a

# 确认磁盘挂载情况
df -h
```

### 4\. 创建交换分区

> 交换分区大小，根据实际需求来创建。一般来情况，如果物理内存是16G，可以设置同等大小16G的swap空间。多机部署环境，建议每台机器都要检查下交换分区配置信息。

```bash
# 先确认下内存情况，交换区没设置，默认大小为0
free -h

# 先关闭所有交换区
swapoff -a

# 设置交换区大小，此处为16G，***交换区大小根据实际情况设置***
dd if=/dev/zero of=/var/swapfile bs=1M count=16384

# 格式化为 swap 分区文件
mkswap /var/swapfile

# 调整为更安全的权限
chmod 0600 /var/swapfile

# 启用交换区
swapon /var/swapfile

# 查看交换文件 UUID
blkid -s UUID /var/swapfile

# 修改 /etc/fstab
# ***以下UUID根据实际情况修改***
cat >> /etc/fstab << EOF

UUID=88306341-9a78-41c7-9831-821cd1e51ca2 swap                   swap    defaults        0 0
EOF

# 确认交换区生效情况
free -h
```

### 5\. 安装内部下载工具

> 该工具用于改善 `svn export` 单文件下载体验，显示下载进度。如果不安装，也可以用 `svn export` 命令替代

```bash
# 安装 svn 命令
yum install -y svn

# 初次使用 svn 命令，会要求输入账号密码，默认以当前系统登录用户尝试登录，会要求输入 root 用户的 svn 密码。此时，直接回车跳过即可。
# 跳过后会要求输入 svn 的用户名和密码，输入完毕提示是否保存密码，***建议选择 yes 保存密码，方便后续操作***
# 
# 部署结束，可以使用以下命令清除保存的 svn 账号信息
# rm -rf ~/.subversion/auth

# 使用 svn 命令下载
mkdir ~/bin
svn export https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E5%B7%A5%E5%85%B7/svn_exporter/svn_exporter ~/bin/

# 设置执行权限
chmod +x ~/bin/svn_exporter

# 添加到 PATH 并应用（可选，多数系统默认已将 ~/bin 添加到PATH，无需重复操作）
cat >> ~/.bash_profile << 'EOF'

export PATH=$PATH:$HOME/bin
EOF
source ~/.bash_profile
```

## 二、安装基础服务

### 1\. 安装JDK

> 运行java后端服务的机器，需要先安装JDK环境

```bash
# 切换到临时目录进行操作
cd /tmp
# 下载 rpm 包
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E5%AE%89%E8%A3%85%E5%8C%85/jdk-8u351-linux-x64.rpm

# 安装
rpm -ivh jdk-8u351-linux-x64.rpm

# 确认安装情况
java -version
```

### 2\. 安装postgresql

> 自建数据库的机器，参考以下步骤安装 postgresql

#### 注意事项

* platformserv 服务部署的机器，需要安装同版本 postgresql 客户端
* ***智慧100推荐使用 postgresql10，高版本 postgresql 无法安装相同版本的 postgis 插件，缺失的函数可能需要额外兼容处理***

```bash

# 安装 postgresql 服务端和客户端
sudo yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
sudo yum install -y postgresql10-server

# ***以下安装步骤仅仅服务端需要执行***

# 设置并初始化数据目录
mkdir -p /home/data/pg_data
chmod 700 /home/data/pg_data
chown postgres:postgres /home/data/pg_data
sudo -u postgres /usr/pgsql-10/bin/pg_ctl initdb -D /home/data/pg_data

# 覆盖 PGDATA 环境变量
mkdir /etc/systemd/system/postgresql-10.service.d
cat > /etc/systemd/system/postgresql-10.service.d/override.conf << EOF
[Service]
Environment=PGDATA=/home/data/pg_data
EOF

# 启动服务
systemctl start postgresql-10

# 设置开机启动
systemctl enable postgresql-10

# 切换到 postgres 用户修改数据库密码
# ***数据库密码根据实际情况进行设置***
# ***此示例密码与nacos归档配置的数据库密码一致，可全局搜索此密码批量调整nacos配置***
sudo -u postgres psql -c "alter user postgres with password 'MuhBiyN6agQ9og4c18YM'"

# 开放远程访问
# 设置 listen_addresses = '*'
sed -i "s/#listen_addresses = 'localhost'/listen_addresses = '*'/g" /home/data/pg_data/postgresql.conf

# 开启信任连接
# 添加网络请求为信任连接
cat >> /home/data/pg_data/pg_hba.conf << EOF
# Allow connections from network
host    all             all             0.0.0.0/0               md5
EOF

# 修改最大连接数
# 设置最大连接数 max_connections = 1000
# 最大连接数按需设置即可，合理使用连接池可减少连接数的使用
sed -i 's/max_connections = 100/max_connections = 1000/g' /home/data/pg_data/postgresql.conf

# 重启服务
systemctl restart postgresql-10

# 安装 postgis 插件
yum install -y postgis23_10

# postgresql13 只能安装 3.0 以上版本的 postgis，部分函数命名有调整，可能需要额外兼容处理，如 ST_Distance_Sphere 函数。兼容方式可参考文末 FAQ 部分
# yum install -y postgis30_13
```

### 3\. 安装redis

```bash
# 安装依赖
yum -y install gcc

# 获取安装包
cd /tmp
wget https://download.redis.io/releases/redis-6.2.7.tar.gz

# 解压并安装
tar -xvf redis-6.2.7.tar.gz
cd redis-6.2.7
make && make install

# 配置 apaas redis
mkdir /etc/redis
cp ./redis.conf /etc/redis/
# 调整配置文件
# 注释掉 bind 127.0.0.1 -::1
sed -i 's/bind 127.0.0.1 -::1/#bind 127.0.0.1 -::1/g' /etc/redis/redis.conf
# 设置 protected-mode no
sed -i 's/protected-mode yes/protected-mode no/g' /etc/redis/redis.conf

# 配置 systemd
cat > /lib/systemd/system/redis.service << EOF
[Unit]
Description=Redis Server 6.2.7
After=network.target

[Service]
ExecStart=/usr/local/bin/redis-server /etc/redis/redis.conf
ExecStop=/usr/local/bin/redis-cli -h 127.0.0.1 -p 6379 shutdown
User=root
Group=root

[Install]
WantedBy=multi-user.target
EOF
# 开机启动
systemctl enable redis
# 启动
systemctl start redis
```

### 4\. 安装RabbitMQ

```bash
# erlang 安装
yum -y install gcc 
yum -y install ncurses-devel
yum -y install openssl openssl-devel
yum -y install socat

# 从 svn 下载安装包
cd /tmp
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E5%AE%89%E8%A3%85%E5%8C%85/otp_src_22.0.tar.gz

# 解压并安装
tar -xvf otp_src_22.0.tar.gz
cd otp_src_22.0
./configure
make && make install

# 修改环境变量
cat >> /etc/profile << 'EOF'

export PATH=$PATH:/usr/local/lib/erlang/bin
EOF
source /etc/profile

# 下载并安装 rabbitmq
cd /tmp
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E5%AE%89%E8%A3%85%E5%8C%85/rabbitmq-server-3.7.17-1.el7.noarch.rpm
rpm -ivh --nodeps rabbitmq-server-3.7.17-1.el7.noarch.rpm

# hostname 为数字时启动 rabbitmq 将会失败，这时需要修改 hostname 为其他名字。/etc/hosts 按需修改。以下示例仅供参考
# hostnamectl set-hostname backend1
# sed -i 's/127.0.0.1\t0001\t0001/127.0.0.1\tbackend1\tbackend1/g' /etc/hosts

# 启动服务
systemctl start rabbitmq-server

# 启用 rabbitmq_management 插件
rabbitmq-plugins enable rabbitmq_management

# 配置 rabbitmq
#   新增用户
rabbitmqctl add_user ipaas ipaas
#   配置角色
rabbitmqctl set_user_tags ipaas administrator
#   配置权限
rabbitmqctl set_permissions -p '/'  ipaas '.*' '.*' '.*'
```

### 5\. 安装openresty

```bash
cd /tmp
wget https://openresty.org/package/centos/openresty.repo
sudo mv openresty.repo /etc/yum.repos.d/

sudo yum check-update
sudo yum install -y openresty

# 从 svn 归档应用配置
# /usr/local/share/lua/
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/openresty/lua.zip
unzip -d /usr/local/share/ lua.zip
# lualib/resty/
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/openresty/lualib/resty/http.lua /usr/local/openresty/lualib/resty/
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/openresty/lualib/resty/http_headers.lua /usr/local/openresty/lualib/resty/
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/openresty/lualib/resty/jit-uuid.lua /usr/local/openresty/lualib/resty/

# nginx.conf 和 script 目录下的配置，归档的为智慧100开发环境配置，不同环境会有差异，以下命令仅供参考
# 实际部署时，请将归档下载到本地后按需调整之后再同步到服务器上
# ***一般来说，智慧100 web前端，智慧100开发环境是部署在 7000 端口，实施环境是部署在 17000 端口，注意按需调整***
# nginx.conf
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/openresty/nginx.conf /usr/local/openresty/nginx/conf/
# script/
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E7%A8%8B%E5%BA%8F%E5%8C%85/nginx/scripts.zip
unzip -d /usr/local/openresty/nginx/ scripts.zip

# 启动 openresty
openresty
```

### 6\. 安装nacos

> 依赖 jdk 环境

```bash
# 下载并安装
cd /tmp
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E5%AE%89%E8%A3%85%E5%8C%85/nacos-server-1.4.2.tar.gz
tar -xzvf nacos-server-1.4.2.tar.gz
mkdir -p /home/apaas/nacos
mv nacos /home/apaas/nacos/
cd /home/apaas/nacos/

# 从归档获取启动脚本
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/nacos/NACOS_operate.sh
chmod +x NACOS_operate.sh

# 启动服务
./NACOS_operate.sh start

# 从 svn 下载 nacos 归档信息，解压后按需调整配置信息，然后重新打包后在web界面导入
# nacos 配置归档地址：https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E7%A8%8B%E5%BA%8F%E5%8C%85/nacos/nacos_config_export_20221123.zip
```

### 7\. 安装filebeat

```bash
# 下载并安装
cd /tmp
wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.0.0-linux-x86_64.tar.gz
mkdir -p /home/filebeat/
tar -xzvf filebeat-8.0.0-linux-x86_64.tar.gz
mv filebeat-8.0.0-linux-x86_64 /home/filebeat/

# 配置
cd /home/filebeat/filebeat-8.0.0-linux-x86_64/
# 将启动脚本拷贝到安装目录
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/filebeat/start.sh
# 将配置文件覆盖到安装目录
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/filebeat/filebeat.yml
# 修改filebeat.yml，将最后一行的client_id修改为本机ip
sed -i "s/client_id: 172.16.3.111/client_id: $(curl ifconfig.me)/g" filebeat.yml

# 启动
sh ./start.sh
```

### 8\. 安装apache-tomcat

```bash
# 切换到临时目录操作
cd /tmp
# 下载包并解压到特定位置
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E5%AE%89%E8%A3%85%E5%8C%85/apache-tomcat-8.5.83.tar.gz
tar -xvf apache-tomcat-8.5.83.tar.gz
mkdir -p /home/apaas/backend
mv apache-tomcat-8.5.83 /home/apaas/backend/apache-tomcat

# 下载运维脚本
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/apache-tomcat/BACKEND_operate.sh /home/apaas/backend/

# 覆盖 server.xml（改端口）
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/apache-tomcat/conf/server.xml /home/apaas/backend/apache-tomcat/conf/

# 设置 jvm 参数
# 以下代码在 "# OS specific support.  $var _must_ be set to either true or false." 行之前（即脚本实际逻辑执行前）插入一行 JVM 参数设置
sed -i '/^# OS specific support.  $var _must_ be set to either true or false.$/i JAVA_OPTS="-Xms4096m -Xmx5120m -noverify -XX:TieredStopAtLevel=1 -Dspring.jmx.enabled=false -Djava.security.egd=file:\/dev\/.\/urandom"\n' /home/apaas/backend/apache-tomcat/bin/catalina.sh

# 设置运维脚本执行权限
cd /home/apaas/backend
chmod +x BACKEND_operate.sh

# 启动
./BACKEND_operate.sh start
```

## 三、业务库初始化

### 1\. apaas 数据库初始化

```bash
# 从 svn 拉取初始化数据
cd /tmp
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/xw_platform_20221127.dump
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/xw_metadata_schema_20221122.dump
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/xw_quartz_schema_20221122.dump
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/xw_operationplatform_20221120.dump
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/di_quartz_schema_20221122.dump
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/xw_metadata_pl_propertytype.sql
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/xw_metadata_init_data_20221127.sql
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/xw_metadata_meta_model_v61.sql
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/xw_metadata_pl_pagewidget_v61.sql
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/xw_metadata_bi_board_v61.sql
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/di_quartz_init_v61.sql

# ***以下操作仅为单机部署示例，多机部署时，数据库地址和端口需根据实际部署情况调整***

# 创建数据库
sudo -u postgres createdb -h localhost -p 5432 -O postgres xw_platform
sudo -u postgres createdb -h localhost -p 5432 -O postgres xw_metadata
sudo -u postgres createdb -h localhost -p 5432 -O postgres xw_quartz
sudo -u postgres createdb -h localhost -p 5432 -O postgres xw_operationplatform
sudo -u postgres createdb -h localhost -p 5432 -O postgres di_quartz

# 初始化数据库
pg_restore -h localhost -p 5432 -U postgres -d xw_platform -F c -v xw_platform_20221127.dump
pg_restore -h localhost -p 5432 -U postgres -d xw_metadata -F c -v xw_metadata_schema_20221122.dump
pg_restore -h localhost -p 5432 -U postgres -d xw_quartz -F c -v xw_quartz_schema_20221122.dump
pg_restore -h localhost -p 5432 -U postgres -d xw_operationplatform -F c -v xw_operationplatform_20221120.dump
pg_restore -h localhost -p 5432 -U postgres -d di_quartz -F c -v di_quartz_schema_20221122.dump

# 初始化元数据库 pl_propertytype 表数据
psql -h localhost -p 5432 -U postgres -w -d xw_metadata -f xw_metadata_pl_propertytype.sql
# 初始化元数据库的一些基础数据
psql -h localhost -p 5432 -U postgres -w -d xw_metadata -f xw_metadata_init_data_20221127.sql
# 插入v61元数据 metamodel
psql -h localhost -p 5432 -U postgres -w -d xw_metadata -f xw_metadata_meta_model_v61.sql
# 插入v61 UI控件元数据
psql -h localhost -p 5432 -U postgres -w -d xw_metadata -f xw_metadata_pl_pagewidget_v61.sql
# 插入v61 报表看板元数据
psql -h localhost -p 5432 -U postgres -w -d xw_metadata -f xw_metadata_bi_board_v61.sql

# 导入产品元数据
# ***待业务服务安装完毕，在IDE v2.9上进行导入***
# 元数据下载地址：https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/MetaModel-2022-11-23.zip

# 初始化 v61 di调度模版
psql -h localhost -p 5432 -U postgres -w -d di_quartz -f di_quartz_init_v61.sql
```

### 2\. 数据平台数据库初始化

```bash
# 从 svn 拉取初始化数据
cd /tmp
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/dataplatform/xw_dataplatform_schema_20221123.dump
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/dataplatform/xw_dataplatform_init_data_20221123.sql

# 创建数据库
sudo -u postgres createdb -h localhost -p 5432 -O postgres xw_dataplatform

# 初始化数据库表结构
pg_restore -h localhost -p 5432 -U postgres -d xw_dataplatform -F c -v xw_dataplatform_schema_20221123.dump
# 初始化基础数据
psql -h localhost -p 5432 -U postgres -w -d xw_dataplatform -f xw_dataplatform_init_data_20221123.sql
```

### 3\. ipaas 数据库初始化

```bash
# svn 拉取初始化数据
cd /tmp
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/ipaas/xw_ipaas_2022112301.sql
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/ipaas/xw_ipaas_plugin_2022112301.sql
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/ipaas/xw_ipaas_quartz_2022112301.sql
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/ipaas/ipaas_init_v61.sql

# 创建数据库
sudo -u postgres createdb -h localhost -p 5432 -O postgres xw_ipaas
sudo -u postgres createdb -h localhost -p 5432 -O postgres xw_ipaas_plugin
sudo -u postgres createdb -h localhost -p 5432 -O postgres xw_ipaas_quartz

# 初始化数据库
psql -h localhost -p 5432 -U postgres -w -d xw_ipaas -f xw_ipaas_2022112301.sql
psql -h localhost -p 5432 -U postgres -w -d xw_ipaas_plugin -f xw_ipaas_plugin_2022112301.sql
psql -h localhost -p 5432 -U postgres -w -d xw_ipaas_quartz -f xw_ipaas_quartz_2022112301.sql

# 插入v6.1版本数据
psql -h localhost -p 5432 -U postgres -w -d xw_ipaas -f ipaas_init_v61.sql
```

## 四、业务服务安装

### 前置准备工作

#### 导入 nacos 配置

1. 下载 nacos 归档配置，svn 地址为 [https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E7%A8%8B%E5%BA%8F%E5%8C%85/nacos/nacos\_config\_export\_20221123.zip](https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E7%A8%8B%E5%BA%8F%E5%8C%85/nacos/nacos_config_export_20221123.zip)
2. 解压配置文件后，可以使用 vscode 或其他现代编辑器打开
3. 根据实际环境部署情况，全局搜索以下信息，进行批量替换：
   1. `MuhBiyN6agQ9og4c18YM` => 替换为数据库实际设置的密码
   2. `127.0.0.1:5432` => 替换为实际数据库部署服务器的内网ip和端口
   3. `127.0.0.1:7000` => 替换ip为实际openresty部署服务器的内网ip
   4. `127.0.0.1:18080` => 替换ip为实际backend服务部署服务器的内网ip
   5. `127.0.0.1:16789` => 替换ip为实际openresty部署服务器的内网ip
4. 下载V6.1服务清单，svn 地址为 [https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E6%96%87%E6%A1%A3%E6%95%B4%E7%90%86/%E6%99%BA%E6%85%A7100V6.1%E6%9C%8D%E5%8A%A1%E6%B8%85%E5%8D%95.xlsx](https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E6%96%87%E6%A1%A3%E6%95%B4%E7%90%86/%E6%99%BA%E6%85%A7100V6.1%E6%9C%8D%E5%8A%A1%E6%B8%85%E5%8D%95.xlsx)
5. nacos 配置文件里，全局搜索 `127.0.0.1`，根据服务清单上的端口，将其余ip替换为对应服务部署服务器的内网ip。配置里 6379 端口对应ip替换为 redis 部署服务器内网ip，ip和端口根据部署情况按需调整
6. 重新打包配置为 zip 文件，注意打包层级与格式。MacOS 系统打包后可能要额外将隐藏文件 `__MACOSX`、`.DS_Store` 删除
7. 在浏览器访问 `{openresty服务器外网ip}:7000/nacos` 地址，将配置导入
8. ***以上替换不能保证覆盖到所有配置项，服务部署后发现有漏了的配置，可以再进行补充调整***

#### 部署目录准备

```bash
# 创建服务根目录
mkdir -p /home/apaas/
mkdir -p /home/apaas/backend
mkdir -p /home/dataplatform
mkdir -p /home/ipaas

# 根据服务部署情况，在各类根目录放置spring配置文件
# ***nacos地址请根据实际部署情况调整***

# /home/apaas/ 目录下的服务默认读取此配置
cat > /home/apaas/application.properties << EOF
nacos.server-addr=127.0.0.1:8848
EOF

# /home/apaas/backend/ 内的服务默认读取此配置
cat > /home/apaas/backend/apache-tomcat/bin/application.properties << EOF
nacos.server-addr=127.0.0.1:8848
nacos.namespace=
nacos.endpoint=
nacos.access-key=
nacos.secret-key=
EOF

# /home/dataplatform/ 目录下的服务默认读取此配置（具体读取配置路径根据服务部署脚本来，实际逻辑会有出入，不一定会用到此配置）
cat > /home/dataplatform/application.properties << EOF
nacos.server-addr=127.0.0.1:8848
EOF

# /home/ipaas/ 目录下的服务默认读取此配置
cat > /home/ipaas/application.yml << EOF
spring:
  main:
    allow-circular-references: true

nacos:
  config:
     enabled: true
  discovery:
     enabled: false
     namespace: public
     group: ipaas
  server-addr: 127.0.0.1:8848

flystepserver:
    icc:
      enabled: false

core:
 config:
   logType: SLS
EOF
```

#### 放置种子文件到特定目录

```bash
# 从 svn 下载租户种子库文件
# 种子文件放置位置可在 nacos 中配置（tenant.db.datapath）
# 实施环境一般配置路径为 /home/apaas/backend/dbs/
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E7%A8%8B%E5%BA%8F%E5%8C%85/dbs/db_100000000000000061.backup /home/apaas/backend/

# 从 svn 下载数据平台种子文件
# 种子文件放置位置可在 nacos 中配置（tenant.dp.datapath）
# 一般配置路径为 /home/dataplatform/backend
mkdir -p /home/dataplatform/backend
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E7%A8%8B%E5%BA%8F%E5%8C%85/dbs/init_tenant_dp_100000000000000061.sql /home/dataplatform/backend/
```

#### 运维工具安装

> `sdhelper` 是基于 svn 归档来对服务进行安装和升级的辅助工具，支持从 svn 拉取安装包、备份服务、安装服务、回滚服务、查看服务状态等常用操作，具体用法可以使用 `sdhelper --help` 查看

```bash
# 安装 sdhelper
# ***该工具依赖于 svn_exporter***
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E5%B7%A5%E5%85%B7/service_deployment_helper/sdhelper ~/bin/
chmod +x ~/bin/sdhelper

# 查看工具使用说明
sdhelper --help
```

#### 获取版本服务清单

```bash
# 获取部署清单
svn_exporter https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E5%B7%A5%E5%85%B7/service_deployment_helper/deployment_v61.yaml /tmp/

# 注意此版本清单，web服务部署在 /home/apaas/web 目录，对应 openresty 监听端口为 7000，与一般实施环境部署目录不同
# ***如果是实施环境升级智慧100v6.1，需要把 web 服务部署到 /home/apaas/websmart 目录，对应 openresty 监听端口为 17000***
# 部署到 /home/apaas/websmart 目录，可以参考以下命令移除 "# dirname: websmart" 配置的注释，也可以手动调整部署清单配置
# sed -i "s/# dirname: websmart/dirname: websmart/g" /tmp/deployment_v61.yaml
```

### 根据服务清单一键安装所有服务

> 一键安装所有服务，***仅适用单机部署情况***。如需多机部署，请参考后文的单个业务服务安装部分

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml install

# 全新环境安装 datamanager-admin 后，需要替换掉 application.yml 的数据连接配置后重启
# 非首次部署 datamanager-admin 时无需执行此步骤
# ***数据库连接信息请根据实际部署情况调整***
sed -i "s/172.16.0.150:15432/127.0.0.1:5432/g" /home/dataplatform/datamanager-admin/application.yml
sed -i "s/password: csb123456/password: MuhBiyN6agQ9og4c18YM/g" /home/dataplatform/datamanager-admin/application.yml
sed -i "s/172.16.0.126:15432/127.0.0.1:5432/g" /home/dataplatform/datamanager-admin/application.yml
sed -i "s/dbPassword: csb123456/dbPassword: MuhBiyN6agQ9og4c18YM/g" /home/dataplatform/datamanager-admin/application.yml
sdhelper -c /tmp/deployment_v61.yaml -s datamanager-admin restart

# 查看 jar 服务状态
sdhelper -c /tmp/deployment_v61.yaml status

# jar 服务全部启动正常后，建议重启一下 backend 服务
cd /home/apaas/backend && ./BACKEND_operate.sh restart
```

### 单个业务服务安装

#### accountserv

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s accountserv pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s accountserv backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s accountserv install

# 查看日志观察是否正常启动
tail -f /home/apaas/backend/apache-tomcat/logs/accountserv/debug.log
```

#### etlserv

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s etlserv pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s etlserv backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s etlserv install

# 查看日志观察是否正常启动
tail -f /home/apaas/backend/apache-tomcat/logs/etlserv/debug.log
```

#### ideserv

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s ideserv pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s ideserv backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s ideserv install

# 查看日志观察是否正常启动
tail -f /home/apaas/backend/apache-tomcat/logs/ideserv/debug.log
```

#### masterserv

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s masterserv pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s masterserv backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s masterserv install

# 查看日志观察是否正常启动
tail -f /home/apaas/backend/apache-tomcat/logs/masterserv/debug.log
```

#### messageserv

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s messageserv pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s messageserv backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s messageserv install

# 查看日志观察是否正常启动
tail -f /home/apaas/backend/apache-tomcat/logs/messageserv/debug.log
```

#### platformserv

##### 注意事项

* 此服务所在机器，需要安装 postgresql 客户端以执行开户
* postgresql 执行目录可在 nacos 中进行配置（tenant.db.binpath）
* 租户种子文件目录可在 nacos 中进行配置（tenant.db.datapath）
* 数据平台种子文件可在 nacos 中进行配置（tenant.dp.datapath）
* ***目前在 PeM5 环境，此服务无法连接 nacos 获取配置，需要特殊处理，具体参考文末 FAQ 部分***

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s platformserv pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s platformserv backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s platformserv install

# 查看日志观察是否正常启动
tail -f /home/apaas/backend/apache-tomcat/logs/platformserv/debug.log
```

#### queueserv

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s queueserv pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s queueserv backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s queueserv install

# 查看日志观察是否正常启动
tail -f /home/apaas/backend/apache-tomcat/logs/queueserv/debug.log
```

#### taskserv

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s taskserv pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s taskserv backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s taskserv install

# 查看日志观察是否正常启动
tail -f /home/apaas/backend/apache-tomcat/logs/taskserv/debug.log
```

#### authserver

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s authserver pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s authserver backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s authserver install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s authserver status
```

#### resourceconfig-service

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s resourceconfig-service pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s resourceconfig-service backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s resourceconfig-service install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s resourceconfig-service status
```

#### dynamic-bizengine

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s dynamic-bizengine pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s dynamic-bizengine backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s dynamic-bizengine install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s dynamic-bizengine status
```

#### impexp

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s impexp pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s impexp backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s impexp install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s impexp status
```

#### offline-engine

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s offline-engine pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s offline-engine backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s offline-engine install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s offline-engine status
```

#### biengine

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s biengine pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s biengine backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s biengine install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s biengine status
```

#### apaasadmin

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s apaasadmin pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s apaasadmin backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s apaasadmin install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s apaasadmin status
```

#### flowengine-rest

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s flowengine-rest pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s flowengine-rest backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s flowengine-rest install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s flowengine-rest status
```

#### processdesigner

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s processdesigner pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s processdesigner backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s processdesigner install
```

#### announcement-rest

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s announcement-rest pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s announcement-rest backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s announcement-rest install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s announcement-rest status
```

#### opendata

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s opendata pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s opendata backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s opendata install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s opendata status
```

#### litheform-service

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s litheform-service pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s litheform-service backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s litheform-service install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s litheform-service status
```

#### lightform-web

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s lightform-web pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s lightform-web backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s lightform-web install
```

#### lightform-configuration

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s lightform-configuration pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s lightform-configuration backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s lightform-configuration install
```

#### apaas/web

##### 注意事项

* 由于 `/home/apaas` 目录和 `/home/ipaas` 目录下都有一个 web 服务，所以这两个服务安装时要一定要加上前缀。注意要使用 `-s apaas/web` 安装此服务，而不是 `-s web`
* 实施环境此服务安装于 /home/apaas/websmart 目录，对应 17000 端口。智慧100环境此服务安装于 /home/apaas/web 目录，对应 7000 端口。安装此服务时需要额外注意

```bash
# 归档的服务部署清单配置文件中将此服务安装于 /home/apaas/web 目录，若需安装到到 /home/apaas/websmart 目录，可以参考以下命令移除 "# dirname: websmart" 配置的注释，也可以手动调整部署清单配置
# sed -i "s/# dirname: websmart/dirname: websmart/g" /tmp/deployment_v61.yaml

# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s apaas/web pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s apaas/web backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s apaas/web install
```

#### appmanager

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s appmanager pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s appmanager backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s appmanager install
```

#### productoperation

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s productoperation pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s productoperation backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s productoperation install
```

#### k100master

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s k100master pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s k100master backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s k100master install
```

#### dym-plugin

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s dym-plugin pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s dym-plugin backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s dym-plugin install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s dym-plugin status
```

#### direport

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s direport pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s direport backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s direport install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s direport status
```

#### wechatservice

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s wechatservice pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s wechatservice backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s wechatservice install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s wechatservice status
```

#### h5-app

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s h5-app pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s h5-app backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s h5-app install
```

#### h5-ide

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s h5-ide pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s h5-ide backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s h5-ide install
```

#### license-service

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s license-service pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s license-service backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s license-service install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s license-service status
```

#### xwdatax

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s xwdatax pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s xwdatax backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s xwdatax install
```

#### datamanager-admin

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s datamanager-admin pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s datamanager-admin backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s datamanager-admin install

# ***归档包包含 application.yml 文件，首次安装时，需手动替换配置中的连接信息，后重启服务***
# ***数据库连接信息请根据实际部署情况调整***
sed -i "s/172.16.0.150:15432/127.0.0.1:5432/g" /home/dataplatform/datamanager-admin/application.yml
sed -i "s/password: csb123456/password: MuhBiyN6agQ9og4c18YM/g" /home/dataplatform/datamanager-admin/application.yml
sed -i "s/172.16.0.126:15432/127.0.0.1:5432/g" /home/dataplatform/datamanager-admin/application.yml
sed -i "s/dbPassword: csb123456/dbPassword: MuhBiyN6agQ9og4c18YM/g" /home/dataplatform/datamanager-admin/application.yml
sdhelper -c /tmp/deployment_v61.yaml -s datamanager-admin restart

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s datamanager-admin status
```

#### datamanager-web

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s datamanager-web pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s datamanager-web backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s datamanager-web install
```

#### dataintegration-executor

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s dataintegration-executor pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s dataintegration-executor backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s dataintegration-executor install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s dataintegration-executor status
```

#### bimobileweb

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s bimobileweb pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s bimobileweb backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s bimobileweb install
```

#### admin

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s admin pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s admin backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s admin install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s admin status
```

#### flystep

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s flystep pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s flystep backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s flystep install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s flystep status
```

#### router

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s router pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s router backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s router install

# 查看服务启动状态
sdhelper -c /tmp/deployment_v61.yaml -s router status
```

#### ipaas/web

##### 注意事项

* 由于 `/home/apaas` 目录和 `/home/ipaas` 目录下都有一个 web 服务，所以这两个服务安装时要一定要加上前缀。注意要使用 `-s ipaas/web` 安装此服务，而不是 `-s web`

```bash
# 拉取清单程序包
sdhelper -c /tmp/deployment_v61.yaml -s ipaas/web pull

# 备份清单所有服务（全新环境无需做备份）
sdhelper -c /tmp/deployment_v61.yaml -s ipaas/web backup

# 安装服务
sdhelper -c /tmp/deployment_v61.yaml -s ipaas/web install
```

## 五、开户验证

### 1\. 导入V6.1元数据

1. 下载 v2.9 版本IDE
   * MacOS版本：[https://xwsvn.wxchina.com/apaas/IDE/V2.9MAC/aPaaS-IDE-V2.9.16-darwin-x64.zip](https://xwsvn.wxchina.com/apaas/IDE/V2.9MAC/aPaaS-IDE-V2.9.16-darwin-x64.zip)
   * Windows版本：[https://xwsvn.wxchina.com/apaas/IDE/V2.9Win/aPaaS-IDE-V2.9.16-win32-x64.zip](https://xwsvn.wxchina.com/apaas/IDE/V2.9Win/aPaaS-IDE-V2.9.16-win32-x64.zip)
2. 安装IDE后进入，添加新环境信息
   * 配置服务地址：`http://{openresty部署服务器外网ip}:8001`
   * 业务服务地址：`http://{openresty部署服务器外网ip}:7000`
3. 选择新建的环境信息，使用自己的开发账号登录（账号可在产品运营平台创建，注册后主要要设置为`产品开发`角色）
4. 下载元数据归档，svn 地址为 [https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/MetaModel-2022-11-23.zip](https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E8%BF%90%E7%BB%B4%E4%BA%A4%E4%BB%98%E5%8C%85/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96/apaas/MetaModel-2022-11-23.zip)
5. 点击左上角 `产品管理` -> `导入`，选择下载的元数据压缩包进行导入
6. 导入完毕后，如果存在部分 SQL 导入失败，会提示下载失败的 SQL，请下载保存。保存后解压文件，在本地数据库客户端连接 `xw_metadata` 数据库，手动尝试导入失败的SQL（部分SQL可能因为引号问题，会插入失败，可以尝试调整SQL后再次插入）

### 2\. 开户验证

1. 浏览器进入产品运营平台，地址为：`http://{openresty部署服务器外网ip}:9018`
2. 使用账号 `tantan` 登录，密码为 `tantan123456`
3. 点击 `新建企业`，填写配置信息后完成创建
4. 点击 `快捷开户`，填写配置信息后点击 `开户`
5. 等待开户完成（若步骤执行失败，可以到服务端看日志进行排查，常见问题可参考文末 FAQ 部分）
6. 开户完成后租户默认为随机密码。可以点击 `管理员账号管理` 新增一个管理员账号，密码默认为 `123456`
7. 浏览器进入智慧100 web 页面，地址为：`http://{openresty部署服务器外网ip}:7000`
8. 使用新建的管理员账号登录系统，进行常规功能验证（遇到报错，可以到后端根据日志排查，常见问题可以参考文末 FAQ 部分）
9. 验证无误则恭喜开户成功！🎉

## 部署常见问题 FAQ

### 工具问题

#### Q: svn 连接超时，无法通过 svn 下载归档资源

A: 目前发现部分华为云服务器ip网段对 xwsvn.wxchina.com 的请求被拒绝，这种情况无法直接通过 svn 下载对应对资源。可以在本地或者任何可以访问 svn 的机器上执行对应下载命令，然后通过 scp 或者其他方式将资源上传到服务器上。

#### Q: svn 提示输入 root 密码

A: 未指定用户名时，svn 默认尝试以系统当前登录用户作为用户名进行登录。一般我们的 svn 账号都不是 root，这个时候直接回车跳过即可。跳过后会提示输入用户名和密码，此时再根据自身 svn 账号密码输入即可。svn 登录成功后会提示是否保存密码，建议选择 yes 保存密码，方便进行后续资源的下载。环境部署完成后，若想移除保存的 svn 密码，可以执行 `rm -rf ~/.subversion/auth` 清除保存的密码信息。

#### Q: sdhelper 工具下载的安装包放在哪个位置

A: 安装包下载位置可以通过配置文件 `deployment_v61.yaml` 中的 `deploy_home.package` 选项进行调整。目前归档的配置，此选项设置为 `/home/apaas/service_deployment_package`，因为在多数实施环境，数据盘挂载在 `/home/apaas` 目录，磁盘空间不会太紧张。若服务器无法直接访问 svn，可以在其他机器上执行 `pull` 命令进行下载，下载完成后，再通过 `scp` 命令或其他方式将此目录同步到服务器上。

#### Q: sdhelper 工具是怎么做备份的，服务目录下原来的文件和日志能否找回

A: 为了维持服务目录的干净整洁，sdhelper 备份时，会将整个服务目录压缩，以 `{服务目录名}.{日期}.tar.gz` 的命名格式，保存在配置文件 `deploy_home.backup` 选项设定的目录里。归档的 `deployment_v61.yaml` 文件此选项设置为 `/home/apaas/service_deployment_backup`。安装服务时，会将原服务目录整个清空，然后再用服务归档安装包初始化服务目录。若需要找回原服务目录下的文件，可以根据日期从备份文件中找回。如果有某些文件，安装时确认需要做保留，可以在 `deployment_v61.yaml` 中配置对应服务的的 `keeps` 选项，此数组定义的文件会在服务安装时自动做保留。

### 异常排查思路

#### Q: 根据服务的ip和端口，如何判断对应了哪个服务

A: 有几个判断思路供参考：

* 多机部署的环境，请结合前面整理的 [服务部署清单](#2-整理服务部署清单) 查看具体的ip和端口对应哪个服务
* 单机部署的环境，如果没有整理服务部署清单，可以根据 [智慧100V6.1服务清单](https://xwsvn.wxchina.com/doc1/zhihui100/V6.1/%E6%96%87%E6%A1%A3%E6%95%B4%E7%90%86/%E6%99%BA%E6%85%A7100V6.1%E6%9C%8D%E5%8A%A1%E6%B8%85%E5%8D%95.xlsx) 里面的端口进行判断
* 如果是客户端请求提供的ip和端口，一般对应的是路由网关服务 openresty，不是具体业务服务的ip和端口，可以通过 nginx 日志进一步判断具体业务服务

#### Q: 如何查看nginx日志

A: 参考思路：

1. 多机部署的环境，请先确定部署 openresty 或者 nginx 服务的具体机器。单机部署的环境可以忽略此步骤
2. 登录服务器后可以使用 `tail -f /usr/local/openresty/nginx/logs/access.log` 或相似命令滚动查看路由访问日志
3. 从接口请求的访问日志中可以判断请求路由的上游地址（后端服务ip和端口），进而判断具体路由到的业务服务
4. 从前端静态资源的访问日志中可以判断请求状态码（具体静态资源位置需到nginx配置中具体查看）

#### Q: nginx路由的服务ip地址不对，需要在哪里修正

A: 参考思路：

* 在路由服务所在机器的 `/usr/local/openresty/nginx/scripts/config/all_upstream.conf` 文件，可以配置大部分服务的上游地址
* 部分路由的上游地址不够规范，需要在 `/usr/local/openresty/nginx/conf/nginx.conf` 中进行配置
* 一般来说，多机部署环境都需要检查和调整以上文件，把没部署在路由服务相同机器上的服务地址改为具体内网ip地址

#### Q: 接口请求出错了，如何确定接口请求了哪个服务

A: 有几个判断思路供参考：

* 根据当前使用的业务功能判断（不一定可靠）
* 根据请求接口路径名进行分析判断（不一定可靠）
* 如果是服务间请求，一般不经过路由网关，可以根据请求端口和ip进行判断（可靠）
* 如果是客户端请求（或者经过路由转发的服务间请求），一般会经过路由网关，可以从nginx日志查看具体的服务路由端口和ip，进而进行判断（可靠）

#### Q: 如何查看服务日志

A: 参考思路：

1. 首先从运维处获得服务器密码，登入服务器
2. 结合服务部署清单、智慧100V6.1服务清单或 `deployment_v61.yaml` 配置文件，确认服务安装目录
3. 进入服务目录使用 `tail` 或 `less` 等命令查看 `logs/debug.log` 或者 `logs/error.log` 等文件

#### Q: 服务启动失败如何排查

A: 参考思路：

1. 根据日志，判断 nacos 连接是否正常，如果连不上nacos，请参考 [Q: platformserv 服务没连上 nacos](#q-platformserv-服务没连上-nacos)
2. 根据日志，判断是哪个 nacos 配置有异常，导致了报错，并检查 nacos 配置（可以导出nacos配置后全局关键字查找）
3. 部分服务未接入nacos（如一站式报表平台相关服务），请检查 spring 配置文件是否配置正确
4. 请检查服务资源是否充足，比如磁盘资源是否足够，内存资源是否足够
5. 业务问题需根据服务日志具体排查

#### Q: 根目录(/)的磁盘满了，是什么问题

A: 参考思路：

* 请确认是否挂载了数据盘
* 请确认数据盘挂载目录是否正确，能覆盖部署服务的安装路径
* 请检查 nginx 日志文件是否过大，导致根目录满了。如果是此问题，可以通过配置日志切分和滚动清除解决
* 请扫描是否有其他特别的大文件占用了空间
* 若排除以上问题，请联系运维同事进行扩容

### 服务安装异常

#### Q: 业务服务没有正确连接上 nacos，导致启动失败或者其他异常

A: 请检查以下配置文件是否存在，并且 nacos 地址和端口配置正确

* `/home/apaas/application.properties`
* `/home/apaas/backend/apache-tomcat/bin/application.properties`
* `/home/dataplatform/application.properties`（可选）
* `/home/ipaas/application.yml`

#### Q: 业务服务报错连接数据库、redis超时，或请求其他服务超时

A: 根据日志判断请求地址、端口或密码是否有误，如果有误，可以将nacos配置导出，全局搜索快速定位到配置位置，并进行修正

#### Q: 请求 backend 18080 端口超时

A: apache-tomcat 默认监听端口为 8080，需要修改，请检查配置文件 /home/apaas/backend/apache-tomcat/conf/server.xml 的端口设置是否正确

#### Q: 如何判断 backend 相关服务是否启动成功，或者是否挂了

A: 思路如下：

* 使用 backend 服务运维脚本启动 tomcat 完成后，需要进入 `/home/apaas/backend/apache-tomcat/logs` 目录查看具体每个服务的日志是否有写入，是否有刷出 spring 启动成功的日志，从而判断 backend 相关服务是否启动成功。
* 如果某个服务的最新日志停留在一个较早时间，可以初步判断该服务已经挂了，需要对 backend 服务进行重启。
* ideserv 服务需要特别关注一下，如果 backend 启动后服务没刷日志，需要尝试再次重启 backend 服务，直到日志正常输出，并最终输出 spring 启动成功信息。
* `/home/apaas/backend/apache-tomcat/bin/catalina.sh` 文件中可以设置 jvm 参数，调大堆内存，可以一定程度让 backend 服务启动更加顺畅。

#### Q: 请求 backend 相关服务404

A: 若一切配置正常，请观察 backend 相关服务的日志是否有正常输出，若新无日志输出，可能相关服务挂了，请重启 backend 服务后再尝试观察日志

### 开户失败

#### Q: 初始化数据库失败，报错缺少 pg\_restore 命令

A: platformserv 所在机器需要安装 postgresql 客户端，同时确保 nacos 配置 {tenant.db.binpath} 路径设置正确

#### Q: 初始化数据库失败，报错缺少对应种子库文件

A: 请确保租户种子库文件已放置于 platformserv 所在服务器上，并且 nacos 配置 {tenant.db.datapath} 路径设置正确

#### Q: 初始化数据平台失败，报错缺少对应种子库库文件

A: 请确保数据平台种子库文件已放置于 platformserv 所在服务器上，并且 nacos 配置 {tenant.dp.datapath} 路径设置正确

#### Q: 初始租户数据库失败，报错 "cannot execute CREATE SCHEMA in a read-only transaction"

A: 请检查 nacos 数据库主从配置是否设置错误

#### Q: platformserv 服务没连上 nacos

A: ***目前在 PeM5 实施环境，存在此问题***。部署完 platformserv 服务后，需要进入 webapps 的 platformserv 目录内，***手动修改 application.properties 配置文件，调整为正确的参数后重启 tomcat***。全新环境一般不会有此问题。

### 业务错误

#### Q: 服务多实例部署时，插入数据时生成的 id 出现冲突

A: 目前采用雪花算法生成 id，不同服务实例需要确保 `datacenterid` 和 `workerid` 参数使用不同的组合，同时服务器时间需要确保已校准。可手动修改下服务的启动脚本 `deploy.sh`，添加不同的启动参数 `-Did.workerid=1 -Did.datacenterid=1` 来避免生成的 id 冲突的问题

#### Q: 业务接口报错缺少 `st_makepoint` 函数

A: 数据库未安装 postgis 插件导致，需要安装 postgis 插件。已开通的租户，需要在租户库执行以下命令

```sql
CREATE EXTENSION IF NOT EXISTS postgis WITH SCHEMA public;
COMMENT ON EXTENSION postgis IS 'PostGIS geometry, geography, and raster spatial types and functions';
```

#### Q: 已安装并启用了 postgis 插件，但是业务接口报错缺少 `st_distance_sphere` 函数

A: 如果是 postgres 13，postgis 插件最低支持版本为 3.0，`st_distance_sphere` 函数已更名为 `st_distancesphere`，添加以下函数进行兼容

```sql
create function st_distance_sphere(geom1 geometry, geom2 geometry) returns double precision
    immutable
    strict
    cost 300
    language sql
as
$$
SELECT public._postgis_deprecate('ST_Distance_Sphere', 'ST_DistanceSphere', '2.2.0');
SELECT public.ST_DistanceSphere($1,$2);
$$;

alter function st_distance_sphere(geometry, geometry) owner to postgres;
```

#### Q: 开户后涉及企微的相关接口会报错不可用

A: 需要先注册企微后，在企业微信中授权登录使用完整功能